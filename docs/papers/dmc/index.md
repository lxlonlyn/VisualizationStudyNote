# Dual Marching Cubes: Primal Contouring of Dual Grids

## 相关文件

[原文 PDF](paper.pdf)

## 主要介绍

## 特征提取

目标：给定 $f(x,y,z)$ 及八叉树，为八叉树的每个“格子”构造一个结点，使其成为对偶网格中的结点。

与其他方法不同，该结点不与曲面特征对齐，而是与隐函数特征对齐。所以，每个结点包含两种信息：位置 $(x,y,z)$ 以及 $f(x,y,z)$ 在该结点位置的估计值 $w$。

为了在八叉树“格子” $c$ 中找到这样的结点，我们使用二次误差函数（QEF）进行评估。我们在 $c$ 的采样点上计算 $f(x,y,z)$ 的切平面，设采样点是 $(x_i,y_i,z_i)$，则 

$$w=T_i(x,y,z)=\nabla f(x_i,y_i,z_i)\cdot((x,y,z)-(x_i,y_i,z_i))$$

根据此生成的 QEF 为

$$E(w,x,y,z)=\sum\limits_{i}\frac{(w-T_i(x,y,z))^2}{1+|\nabla f(x_i,y_i,z_i)|^2}$$

接下来的目标是最小化 $E(w,x,y,z)$ 以找到 $c$ 中对偶网格中的结点 $(w,x,y,z)$。如果无法计算最小值，则将最小值定位近似于 $c$ 的中心。

### 八叉树构建

八叉树的构造由一个“格子” $c$ 开始，使用上述的采样算法进行采样（也可以随机采样），之后构造 QEF 函数并将其最小化。若误差值 $E(w,x,y,z)$ 超过规定的最大误差值 $\epsilon$，则将目前的“格子”划分成 8 个小格子，执行目前的操作。这样的操作递归进行，直到每个叶子结点误差值不超过 $\epsilon$。

## 拓扑结构构建

为了简化，一下内容用四叉树及平面进行演示，可以较为方便地扩展成八叉树及立体。

任务：给定四叉树 $q$，使用有效的方法找到对偶网格中的每个格子，且不需要在四叉树中找到确定的邻居。

方法是使用一种递归遍历 $q$，枚举所有具有相同结点的格子。

遍历涉及三个递归函数 $faceProc(q_1)$、$edgeProc(q_1,q_2)$ 及 $vertProc(q_1,q_2,q_3,q_4)$。以下是详细说明：

1. 给定四叉树内部结点 $q_1$，递归涉及以下三个操作：
    1. $faceProc$ 调用 $q_1$ 的四个子结点；
    2. $edgeProc$ 调用 4 对具有公共边的 $q_1$ 的子结点；
    3. $vertProc$ 调用其 4 个子结点（4 子结点作为 1 次调用）；
2. 给定四叉树一对内部结点 $q_1,q_2$，涉及：
    1. $edgeProc$ 调用 2 对公共边为 $q_1,q_2$ 公共边一部分的子结点；
    2. $vertProc$ 调用与 $q_1,q_2$ 公共边相邻的四个结点；
3. 给定四叉树四个具有公共点的内部结点 $q_1,q_2,q_3,q_4$，涉及：
    1. $vertProc$ 调用与 $q_1,q_2,q_3,q_4$ 中心具有四个顶点的子结点；

![递归函数 faceProc（黑色）edgeProc（深灰）vertProc（浅灰）](recursive%20functions.png)

递归函数 faceProc（黑色）edgeProc（深灰）vertProc（浅灰）。

当递归调用中出现叶子结点时，则将其代替其子结点。当所有的参数都是四叉树的叶子结点时，递归终止。递归终止时，我们将特征提取阶段的顶点连接起来，便得到了正方形。由于程序的自适应，四个结点中可能出现一个重复结点，形成三角形。该方法具有与四叉树大小一致的线性复杂度。

在上述描述中，faceProc 只生成四叉树根内部结点。为了将对偶网格扩展到四叉树边界，我们将目前的四叉树视为 $3\times 3$ 网格的中心结点，其余 4 个结点参与组成四叉树的边界，4 个结点参与组成四叉树的边界顶点。

## 绘制轮廓

生成对偶网格后，使用 Marching Cube 生成提取曲面。在构建拓扑结构时生成的每个结点可以看作是立方体。在对偶网格结点使用标量值 $w$ 来计算每条具有符号变化边的边交点，使用 Marching Cube 的查找表来生成内部表面拓扑。